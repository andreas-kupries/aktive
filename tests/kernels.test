# -*- tcl -*- tcl.tk//DSL tcltest//EN//2.0 tcl.tk//DSL tcltest//EN//2.0
## (c) 2023 Andreas Kupries
# # ## ### ##### ######## ############# #####################
## AKTIVE. Patterns for kernels.

kt check Tcl     8.6
kt check tcltest 2

# # ## ### ##### ######## ############# #####################

kt local testing aktive

kt source support/util.tcl

# # ## ### ##### ######## ############# #####################
## Syntax

syntax {
    emboss {}
} {aktive image kernel}

syntax {
    4 {}
    5 {}
    8 {}
    9 {}
    X {}
    X1 {}
} {aktive image kernel laplace}

syntax {
    discrete args
} {aktive image kernel gauss}

syntax {
    x  {}
    y  {}
    xy {}
} {aktive image kernel gauss3}

syntax {
    x  {}
    y  {}
} {aktive image kernel gauss5}

syntax {
    x  {}
    y  {}
} {aktive image kernel gauss7}

syntax {
    x  {}
    y  {}
} {aktive image kernel gauss9}

syntax {
    md {}
    sd {}
    x  {}
    y  {}
} {aktive image kernel kirsch}

syntax {
    md {}
    sd {}
    x  {}
    y  {}
} {aktive image kernel prewitt}

syntax {
    x  {}
    y  {}
} {aktive image kernel roberts}

syntax {
    x  {}
    y  {}
} {aktive image kernel scharr}

syntax {
    md {}
    sd {}
    x  {}
    y  {}
} {aktive image kernel sobel}

# # ## ### ##### ######## ############# #####################

foreach {op w h f expected} {
    emboss 3 3 {} {
	2.0  0.0  0.0
	0.0 -1.0  0.0
	0.0  0.0 -1.0
    }
    {laplace 4} 3 3 {} {
	=  0.0 -1.0  0.0
	= -1.0  4.0 -1.0
	=  0.0 -1.0  0.0
    }
    {laplace 5} 3 3 {} {
	=  0.0 -1.0  0.0
	= -1.0  5.0 -1.0
	=  0.0 -1.0  0.0
    }
    {laplace 8} 3 3 {} {
	-1.0 -1.0 -1.0
	-1.0  8.0 -1.0
	-1.0 -1.0 -1.0
    }
    {laplace 9} 3 3 {} {
	-1.0 -1.0 -1.0
	-1.0  9.0 -1.0
	-1.0 -1.0 -1.0
    }
    {laplace X} 3 3 {} {
	=  1.0 -2.0  1.0
	= -2.0  4.0 -2.0
	=  1.0 -2.0  1.0
    }
    {laplace X1} 3 3 {} {
	=  1.0 -2.0  1.0
	= -2.0  5.0 -2.0
	=  1.0 -2.0  1.0
    }
    {gauss3 x} 3 1 0.25 {
	0.25 0.5 0.25
    }
    {gauss3 y} 1 3 0.25 {
	0.25
	0.5
	0.25
    }
    {gauss3 xy} 3 3 0.0625 {
	0.0625 0.125  0.0625
	0.125  0.25   0.125
	0.0625 0.125  0.0625
    }
    {gauss5 x} 5 1 0.0625 {
	0.0625 0.25 0.375 0.25 0.0625
    }
    {gauss5 y} 1 5 0.0625 {
	0.0625 0.25 0.375 0.25 0.0625
    }
    {gauss7 x} 7 1 0.015625 {
	0.015625 0.09375 0.234375 0.3125 0.234375 0.09375 0.015625
    }
    {gauss7 y} 1 7 0.015625 {
	0.015625 0.09375 0.234375 0.3125 0.234375 0.09375 0.015625
    }
    {gauss9 x} 9 1 0.0078125 {
	0.0078125 0.0625 0.21875 0.4375 0.546875 0.4375 0.21875 0.0625 0.0078125
    }
    {gauss9 y} 1 9 0.0078125 {
	0.0078125 0.0625 0.21875 0.4375 0.546875 0.4375 0.21875 0.0625 0.0078125
    }
    {kirsch md} 3 3 {} {
	= -3.0  5.0  5.0
	= -3.0  0.0  5.0
	= -3.0 -3.0 -3.0
    }
    {kirsch sd} 3 3 {} {
	=  5.0  5.0 -3.0
	=  5.0  0.0 -3.0
	= -3.0 -3.0 -3.0
    }
    {kirsch x} 3 3 {} {
	= 5.0 -3.0 -3.0
	= 5.0  0.0 -3.0
	= 5.0 -3.0 -3.0
    }
    {kirsch y} 3 3 {} {
	=  5.0  5.0  5.0
	= -3.0  0.0 -3.0
	= -3.0 -3.0 -3.0
    }
    {prewitt md} 3 3 {} {
	=  0.0  1.0  1.0
	= -1.0  0.0  1.0
	= -1.0 -1.0  0.0
    }
    {prewitt sd} 3 3 {} {
	= -1.0 -1.0  0.0
	= -1.0  0.0  1.0
	=  0.0  1.0  1.0
    }
    {prewitt x} 3 3 {} {
	= -1.0 0.0 1.0
	= -1.0 0.0 1.0
	= -1.0 0.0 1.0
    }
    {prewitt y} 3 3 {} {
	= -1.0 -1.0 -1.0
	=  0.0  0.0  0.0
	=  1.0  1.0  1.0
    }
    {roberts x} 3 3 {} {
	0.0 -1.0 0.0
	1.0  0.0 0.0
	0.0  0.0 0.0
    }
    {roberts y} 3 3 {} {
	= -1.0 0.0 0.0
	=  0.0 1.0 0.0
	=  0.0 0.0 0.0
    }
    {scharr x} 3 3 {} {
	=  -3.0 0.0  3.0
	= -10.0 0.0 10.0
	=  -3.0 0.0  3.0
    }
    {scharr y} 3 3 {} {
	= -3.0 -10.0 -3.0
	=  0.0   0.0  0.0
	=  3.0  10.0  3.0
    }
    {sobel md} 3 3 {} {
	0.0 -1.0 -1.0
	2.0  0.0 -2.0
	1.0  1.0  0.0
    }
    {sobel sd} 3 3 {} {
	1.0  1.0  0.0
	2.0  0.0 -2.0
	0.0 -1.0 -1.0
    }
    {sobel x} 3 3 {} {
	1.0 0.0 -1.0
	2.0 0.0 -2.0
	1.0 0.0 -1.0
    }
    {sobel y} 3 3 {} {
	=  1.0  2.0  1.0
	=  0.0  0.0  0.0
	= -1.0 -2.0 -1.0
    }
} {
    if {$f eq {}} { set f 1.0 }
    set ex [lmap v [clearValues $expected] { expr {$v/$f} }]

    test aktive-image-kernel-[join ${op} -]-2.0 "aktive image kernel $op" -body {
	astcl aktive image kernel {*}$op
    } -match image -result \
	[makei image::from::matrix \
	     0 0 $w $h 1 \
	     "width $w height $h factor $f values {$ex}" \
	     $expected]
}

foreach {w sigma radius expected} {
    7 1 {} {
	0.00817354614528688 0.050050459008838366 0.2083753822208082 0.46680122525013323 0.2083753822208082 0.050050459008838366 0.00817354614528688
    }
    13 2 {} {
	0.0028346348360403896 0.009262364466555768 0.025990547488110003 0.06124348267267125 0.11785604749081606 0.17910193775682604 0.2074219705779609 0.17910193775682604 0.11785604749081606 0.06124348267267125 0.025990547488110003 0.009262364466555768 0.0028346348360403896
    }
    19 3 {} {
	0.0016729654767838275 0.003993880020544228 0.008773204805822304 0.0176411504582495 0.03229515745726288 0.05352704846876334 0.07988639074380655 0.10683275522706058 0.1275365338040747 0.13568182707526405 0.1275365338040747 0.10683275522706058 0.07988639074380655 0.05352704846876334 0.03229515745726288 0.0176411504582495 0.008773204805822304 0.003993880020544228 0.0016729654767838275
    }
    25 4 {} {
	0.0011832207684653808 0.0023430387321625836 0.004404921405116486 0.007849299689545544 0.013235870572574691 0.0210871494217228 0.03169443836546633 0.04488250211323317 0.0598206490907978 0.0749993489581433 0.08846706053362663 0.09833016674964001 0.10340466719901047 0.09833016674964001 0.08846706053362663 0.0749993489581433 0.0598206490907978 0.04488250211323317 0.03169443836546633 0.0210871494217228 0.013235870572574691 0.007849299689545544 0.004404921405116486 0.0023430387321625836 0.0011832207684653808
    }
    7 4 {radius 3} {
	0.11961660248866841 0.1410962809703536 0.15682696759541778 0.16492029789112042 0.15682696759541778 0.1410962809703536 0.11961660248866841
    }
} {
    test aktive-image-kernel-gauss-discrete-2.0.${sigma}-$w "aktive image kernel gauss discrete $sigma $radius (w $w)" -body {
	astcl aktive image kernel gauss discrete sigma $sigma {*}$radius
    } -match image -result \
	[makei image::from::matrix \
	     0 0 $w 1 1 \
	     "width $w height 1 factor 1.0 values {[string trim $expected]}" \
	     $expected]

}

# # ## ### ##### ######## ############# #####################
cleanupTests
return
