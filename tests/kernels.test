# -*- tcl -*- tcl.tk//DSL tcltest//EN//2.0 tcl.tk//DSL tcltest//EN//2.0
## (c) 2023,2024 Andreas Kupries
# # ## ### ##### ######## ############# #####################
## AKTIVE. Patterns for kernels.

kt check Tcl     8.6 9
kt check tcltest 2

# # ## ### ##### ######## ############# #####################

kt local testing aktive

kt source support/util.tcl

# # ## ### ##### ######## ############# #####################
## Syntax

syntax {
    emboss  {}
    lanczos args
} {aktive image kernel}

foreach cmd {
    laplace sharp
} {
    syntax {
	4 {}
	8 {}
	X {}
    } [list aktive image kernel $cmd]
}

syntax {
    discrete args
} {aktive image kernel gauss}

foreach cmd {
    gauss3 gauss5 gauss7 gauss9 kirsch prewitt roberts scharr sobel
} {
    syntax {
	x  {}
	y  {}
    } [list aktive image kernel $cmd]
}

foreach cmd {
    kirsch prewitt sobel
} {
    syntax {
	md {}
	sd {}
    } [list aktive image kernel $cmd]
}

syntax {
    xy {}
} {aktive image kernel gauss3}

# # ## ### ##### ######## ############# #####################

foreach {op w h f expected} {
    emboss 3 3 {} {
	2.0  0.0  0.0
	0.0 -1.0  0.0
	0.0  0.0 -1.0
    }
    {laplace 4} 3 3 {} {
	=  0.0 -1.0  0.0
	= -1.0  4.0 -1.0
	=  0.0 -1.0  0.0
    }
    {laplace 8} 3 3 {} {
	-1.0 -1.0 -1.0
	-1.0  8.0 -1.0
	-1.0 -1.0 -1.0
    }
    {laplace X} 3 3 {} {
	=  1.0 -2.0  1.0
	= -2.0  4.0 -2.0
	=  1.0 -2.0  1.0
    }
    {sharp 4} 3 3 {} {
	=  0.0 -1.0  0.0
	= -1.0  5.0 -1.0
	=  0.0 -1.0  0.0
    }
    {sharp 8} 3 3 {} {
	-1.0 -1.0 -1.0
	-1.0  9.0 -1.0
	-1.0 -1.0 -1.0
    }
    {sharp X} 3 3 {} {
	=  1.0 -2.0  1.0
	= -2.0  5.0 -2.0
	=  1.0 -2.0  1.0
    }
    {gauss3 x} 3 1 0.25 {
	0.25 0.5 0.25
    }
    {gauss3 y} 1 3 0.25 {
	0.25
	0.5
	0.25
    }
    {gauss3 xy} 3 3 0.0625 {
	0.0625 0.125  0.0625
	0.125  0.25   0.125
	0.0625 0.125  0.0625
    }
    {gauss5 x} 5 1 0.0625 {
	0.0625 0.25 0.375 0.25 0.0625
    }
    {gauss5 y} 1 5 0.0625 {
	0.0625 0.25 0.375 0.25 0.0625
    }
    {gauss7 x} 7 1 0.015625 {
	0.015625 0.09375 0.234375 0.3125 0.234375 0.09375 0.015625
    }
    {gauss7 y} 1 7 0.015625 {
	0.015625 0.09375 0.234375 0.3125 0.234375 0.09375 0.015625
    }
    {gauss9 x} 9 1 0.0078125 {
	0.0078125 0.0625 0.21875 0.4375 0.546875 0.4375 0.21875 0.0625 0.0078125
    }
    {gauss9 y} 1 9 0.0078125 {
	0.0078125 0.0625 0.21875 0.4375 0.546875 0.4375 0.21875 0.0625 0.0078125
    }
    {kirsch md} 3 3 {} {
	= -3.0  5.0  5.0
	= -3.0  0.0  5.0
	= -3.0 -3.0 -3.0
    }
    {kirsch sd} 3 3 {} {
	=  5.0  5.0 -3.0
	=  5.0  0.0 -3.0
	= -3.0 -3.0 -3.0
    }
    {kirsch x} 3 3 {} {
	= 5.0 -3.0 -3.0
	= 5.0  0.0 -3.0
	= 5.0 -3.0 -3.0
    }
    {kirsch y} 3 3 {} {
	=  5.0  5.0  5.0
	= -3.0  0.0 -3.0
	= -3.0 -3.0 -3.0
    }
    {prewitt md} 3 3 {} {
	=  0.0  1.0  1.0
	= -1.0  0.0  1.0
	= -1.0 -1.0  0.0
    }
    {prewitt sd} 3 3 {} {
	= -1.0 -1.0  0.0
	= -1.0  0.0  1.0
	=  0.0  1.0  1.0
    }
    {prewitt x} 3 3 {} {
	= -1.0 0.0 1.0
	= -1.0 0.0 1.0
	= -1.0 0.0 1.0
    }
    {prewitt y} 3 3 {} {
	= -1.0 -1.0 -1.0
	=  0.0  0.0  0.0
	=  1.0  1.0  1.0
    }
    {roberts x} 3 3 {} {
	0.0 -1.0 0.0
	1.0  0.0 0.0
	0.0  0.0 0.0
    }
    {roberts y} 3 3 {} {
	= -1.0 0.0 0.0
	=  0.0 1.0 0.0
	=  0.0 0.0 0.0
    }
    {scharr x} 3 3 {} {
	=  -3.0 0.0  3.0
	= -10.0 0.0 10.0
	=  -3.0 0.0  3.0
    }
    {scharr y} 3 3 {} {
	= -3.0 -10.0 -3.0
	=  0.0   0.0  0.0
	=  3.0  10.0  3.0
    }
    {sobel md} 3 3 {} {
	0.0 -1.0 -1.0
	2.0  0.0 -2.0
	1.0  1.0  0.0
    }
    {sobel sd} 3 3 {} {
	1.0  1.0  0.0
	2.0  0.0 -2.0
	0.0 -1.0 -1.0
    }
    {sobel x} 3 3 {} {
	1.0 0.0 -1.0
	2.0 0.0 -2.0
	1.0 0.0 -1.0
    }
    {sobel y} 3 3 {} {
	=  1.0  2.0  1.0
	=  0.0  0.0  0.0
	= -1.0 -2.0 -1.0
    }
} {
    if {$f eq {}} { set f 1.0 }
    set ex [lmap v [clearValues $expected] { expr {$v/$f} }]

    test aktive-image-kernel-[join ${op} -]-2.0 "aktive image kernel $op" -body {
	astcl aktive image kernel {*}$op
    } -match image -result \
	[makei image::from::matrix \
	     0 0 $w $h 1 \
	     "x 0 y 0 width $w height $h factor $f values {$ex}" \
	     $expected]
}

foreach {w sigma radius expected} {
    7 1 {} {
	0.00817354614528688 0.050050459008838366 0.2083753822208082 0.46680122525013323 0.2083753822208082 0.050050459008838366 0.00817354614528688
    }
    13 2 {} {
	0.0028346348360403896 0.009262364466555768 0.025990547488110003 0.06124348267267125 0.11785604749081606 0.17910193775682604 0.2074219705779609 0.17910193775682604 0.11785604749081606 0.06124348267267125 0.025990547488110003 0.009262364466555768 0.0028346348360403896
    }
    19 3 {} {
	0.0016729654767838275 0.003993880020544228 0.008773204805822304 0.0176411504582495 0.03229515745726288 0.05352704846876334 0.07988639074380655 0.10683275522706058 0.1275365338040747 0.13568182707526405 0.1275365338040747 0.10683275522706058 0.07988639074380655 0.05352704846876334 0.03229515745726288 0.0176411504582495 0.008773204805822304 0.003993880020544228 0.0016729654767838275
    }
    25 4 {} {
	0.0011832207684653808 0.0023430387321625836 0.004404921405116486 0.007849299689545544 0.013235870572574691 0.0210871494217228 0.03169443836546633 0.04488250211323317 0.0598206490907978 0.0749993489581433 0.08846706053362663 0.09833016674964001 0.10340466719901047 0.09833016674964001 0.08846706053362663 0.0749993489581433 0.0598206490907978 0.04488250211323317 0.03169443836546633 0.0210871494217228 0.013235870572574691 0.007849299689545544 0.004404921405116486 0.0023430387321625836 0.0011832207684653808
    }
    7 4 {radius 3} {
	0.11961660248866841 0.1410962809703536 0.15682696759541778 0.16492029789112042 0.15682696759541778 0.1410962809703536 0.11961660248866841
    }
} {
    test aktive-image-kernel-gauss-discrete-2.0.${sigma}-$w "aktive image kernel gauss discrete $sigma $radius (w $w)" -body {
	astcl aktive image kernel gauss discrete sigma $sigma {*}$radius
    } -match image -result \
	[makei image::from::matrix \
	     0 0 $w 1 1 \
	     "x 0 y 0 width $w height 1 factor 1.0 values {[string trim $expected]}" \
	     $expected]

}

test aktive-image-kernel-lanczos-2.0 "aktive image kernel lanczos (3, 0.1)" -body {
    astcl aktive image kernel lanczos order 3 step 0.1
} -match image -result [makei image::from::matrix 0 0 59 1 1 {x 0 y 0 width 59 height 1 factor 1.0 values {0.0011674611659629845 0.004738087123437777 0.010423990086660274 0.01739379866942042 0.024317084074161062 0.02950013726367277 0.031105298763475033 0.027432683386570903 0.017231493816724095 -1.6118810779404376e-17 -0.023769871506233296 -0.05244468846875165 -0.08323111356073912 -0.11230580845470207 -0.13509491152311703 -0.14668513757348836 -0.1423301291068262 -0.11800054905469118 -0.07091672408058033 3.223762155880875e-17 0.09381591077994242 0.20745966811094238 0.33581026624241417 0.4720021962187646 0.6079271018540265 0.7348879937830122 0.8443431970194815 0.9286650761938039 0.9818348405748805 1.0 0.9818348405748805 0.9286650761938039 0.8443431970194815 0.7348879937830122 0.6079271018540265 0.4720021962187646 0.33581026624241417 0.20745966811094238 0.09381591077994242 3.223762155880875e-17 -0.07091672408058033 -0.11800054905469118 -0.1423301291068262 -0.14668513757348836 -0.13509491152311703 -0.11230580845470207 -0.08323111356073912 -0.05244468846875165 -0.023769871506233296 -1.6118810779404376e-17 0.017231493816724095 0.027432683386570903 0.031105298763475033 0.02950013726367277 0.024317084074161062 0.01739379866942042 0.010423990086660274 0.004738087123437777 0.0011674611659629845}} {
    =  0.0012  0.0047  0.0104  0.0174  0.0243  0.0295  0.0311  0.0274  0.0172
    = -0.0000 -0.0238 -0.0524 -0.0832 -0.1123 -0.1351 -0.1467 -0.1423 -0.1180 -0.0709
    =  0.0000  0.0938  0.2075  0.3358  0.4720  0.6079  0.7349  0.8443  0.9287  0.9818
    =  1.0000
    =  0.9818  0.9287  0.8443  0.7349  0.6079  0.4720  0.3358  0.2075  0.0938  0.0000
    = -0.0709 -0.1180 -0.1423 -0.1467 -0.1351 -0.1123 -0.0832 -0.0524 -0.0238 -0.0000
    =  0.0172  0.0274  0.0311  0.0295  0.0243  0.0174  0.0104  0.0047  0.0012

}]

# # ## ### ##### ######## ############# #####################
## Kernel errors

test aktive-image-kernel-gauss-discrete-3.0 "aktive image kernel gauss discrete, bad sigma" -body {
    astcl aktive image kernel gauss discrete sigma -1
} -returnCodes error -errorCode {AKTIVE ERROR} -result {Invalid sigma -1, expected a value > 0}

test aktive-image-kernel-lanczos-3.0 "aktive image kernel lanczos, bad order" -body {
     aktive image kernel lanczos order 1
} -returnCodes error -errorCode {AKTIVE ERROR} -result {Invalid order 1, expected a value >= 2}

# # ## ### ##### ######## ############# #####################
cleanupTests
return
